# LINEスタンプ作成機能

変換済みアイコンを元に **AI で LINE 申請用スタンプ画像を生成**し、ダウンロードする機能。Phase 1 では **1 ワードのみ選択して 1 枚生成**。Phase 2 では **`line-stamp-automation` を利用して複数ワードから複数スタンプを自動生成**し、ZIP 一括ダウンロードまで行う。

- **仕様書**: [line-stamp-spec.md](../requirements/line-stamp-spec.md)
- **結果画面からの入口**: [結果・プレビュー画面](result.md) のアクションボタン領域に「LINEスタンプ用に作る」ボタンを追加

[← 画面一覧に戻る](../ui-features.md)

---

## フェーズ概要

| フェーズ | ワード選択 | 画像生成 | 出力 |
|----------|------------|----------|------|
| **Phase 1（現行）** | **1 ワードのみ** | AI で 1 枚生成 | 1 枚の PNG ダウンロード |
| **Phase 2（複数スタンプ自動生成）** | 複数選択可能 | `line-stamp-automation` で複数枚自動生成 | ZIP 一括ダウンロード |

---

## 実装タスク一覧（Phase 1）

- [x] **結果画面への入口**
  - 結果画面（`/result`）のアクションボタン領域に「LINEスタンプ用に作る」ボタンを 1 つ追加
  - 配置: 「保存」「Post」の下、または「もう一度作る」の上/下。既存の `UButton`・`rounded-3xl` 等に合わせる
  - クリックで `/result/line-stamp` へ遷移（`NuxtLink` または `navigateTo`）
- [x] **LINEスタンプ作成ページの新設**
  - ルート: `/result/line-stamp`。レイアウトはモバイルファースト 1 カラム、既存の `max-w-md` 等に合わせる
  - ヘッダー: タイトル「LINEスタンプ用に書き出し」（戻るボタンはなし）
  - 元画像なし（`resultImageUrl` 未設定）で直接アクセスされた場合は結果画面へリダイレクト
- [x] **プリセットデータ・型定義**
  - `StampWord`（id, label, group）・`StampSet`（id, name, wordIds, type）・`StampCategory`（id, name, setIds）の型定義
  - 単語プリセット定数: あいさつ・感謝・リアクション・応援・愛情・ごめん・フォロー（仕様 3.2.1 の初期実装分）
  - セット定数: あいさつ・感謝・リアクション・愛情・フォロー・応援、および **おすすめ8個（申請用）**（仕様 3.2.2）
  - おすすめ8個セットは UI で目立つ位置に配置
- [x] **文言選択 UI（単一選択＋自由入力）**
  - プリセット（単語）から **1 ワードのみ** 選択可能。チップまたはカードで単一選択 UI。
  - **ユーザーの自由入力**も可能（1 文言、最大文字数制限あり）。プリセットと自由入力は排他（どちらか一方のみ）。
  - セット一括選択・「おすすめ8個」の一括選択は Phase 1 では提供しない（将来サブスクで解放）。セットタブではセット内の単語を 1 つ選ぶ単一選択として表示。
  - Phase 2 では、プリセットからの複数ワード選択および複数文言の自由入力を許可し、選択された複数テキストを `line-stamp-automation` に渡して複数スタンプを自動生成する（最大個数は LINE スタンプ申請要件と料金設計に合わせて制限）。
- [x] **プレビュー廃止・AI 生成フロー**
  - Canvas によるプレビュー表示は **廃止**。代わりに「スタンプを生成」CTA を配置し、AI 生成完了後に **生成結果 1 枚** を表示する。
- [x] **AI でスタンプ 1 枚生成**
  - API（POST /api/line-stamp/generate）で元画像＋1 文言を AI に渡し、スタンプ画像を 1 枚生成。生成中表示・完了後の画像表示・1 枚の PNG ダウンロードを実装。
- [x] **ストア・状態の見直し**
  - 選択は **wordId 1 件または自由入力 1 件**。AI 生成中フラグ・生成結果画像 URL ・エラーメッセージを保持する。
- [x] **申請注記・FAQ**
  - 申請注記は実装済み。FAQ は必要に応じて追加。

※ ZIP ダウンロード・メイン/タブ画像オプション・複数選択は **Phase 2（複数スタンプ自動生成）** で実装予定（サブスク上位プランでの提供を想定）。

---

## 5.1 結果画面の変更（入口）

- [x] **「LINEスタンプ用に作る」ボタン**
  - アクションボタン領域に 1 つ追加。配置は「保存」「Post」の下、または「もう一度作る」の上/下
  - `UButton` を使用し、既存の `result.vue` のスタイル（`rounded-3xl` 等）に合わせる
  - クリックで `/result/line-stamp` へ遷移

## 5.2 LINEスタンプ作成ページ（`/result/line-stamp`）

- [x] **ページ骨格・ガード**
  - ルート: `/result/line-stamp`。モバイルファースト 1 カラム、`max-w-md` 等で最大幅を既存に合わせる
  - ヘッダー: タイトル「LINEスタンプ用に書き出し」（戻るボタンはなし）
  - `generationStore.resultImageUrl` が無い場合は結果画面へリダイレクト
- [x] **申請注記の表示**（5.6 確定仕様）
  - ヘッダー直下、または CTA の上に「LINEクリエイターズマーケットへの申請はご自身でお願いします」を1行で表示
  - 必要に応じて LINE Creators Market（https://creator.line.me/ja/）への外部リンクを併記（`<a target="_blank" rel="noopener noreferrer">`）
- [x] **元画像エリア**
  - 完成したアイコン画像のプレビュー（AI 生成の参照元として表示）。`resultImageUrl` を `NuxtImg` で表示
- [x] **文言選択ブロック（単一選択＋自由入力）**
  - 見出し文言: 「テキストを1つ選択してください」
  - タブは初期表示時に **単語** を選択。**セット** タブは Phase 1 では非活性とし、作成中である旨をツールチップで案内。
  - プリセット（単語）から **1 ワードのみ** 選択。チップまたはカードで単一選択 UI。
  - **自由入力欄**（その他）は幅・高さを広めにし入力しやすくする（UTextarea、複数行）。プリセット以外の文言を 1 件入力可能（最大文字数制限あり）。プリセット選択時は自由入力をクリア、自由入力時はプリセット選択をクリア。
  - セット・おすすめ8個は Phase 1 では一括選択ではなく、セット内の単語を 1 つ選ぶ単一選択として表示。
  - ページ専用コンポーネント: `StampPresetSelector.vue`
- [x] **プレビュー廃止・生成結果表示**
  - Canvas プレビューは **廃止**。主 CTA「スタンプを生成」は LINE ブランドカラー（#06C755）で視認性を高めて表示。実行後、AI 生成が完了したら **生成結果 1 枚** を表示するブロック（`StampGenerateBlock.vue`）を用意
- [x] **ダウンロード（Phase 1）**
  - 生成完了後に「画像をダウンロード」で 1 枚の PNG をダウンロード。ZIP は将来（サブスク）で提供

※ メイン画像・タブ画像を含む ZIP ダウンロードは **Phase 2（複数スタンプ自動生成）** で実装（常に ZIP に同梱する）。

## 5.3 データ・定数・ストア

- [x] **型定義**
  - `StampWordGroup`（aisatsu, kansha, reaction, oen, ai_follow, gomen_follow 等）
  - `StampWord`（id, label, group）、`StampSet`（id, name, wordIds, type?）、`StampCategory`（id, name, setIds）
  - `StampSetType`: `'required' | 'recommended_8' | 'extended'`
- [x] **単語プリセット定数**
  - 仕様 3.2.1 に基づく単語一覧（あいさつ・感謝・リアクション・応援・愛情・ごめん・フォロー）。初期実装では仕事用・季節は Phase 2
- [x] **セット・カテゴリ定数**
  - 必須セット: あいさつ・感謝・リアクション・愛情・フォロー・応援
  - 推奨8個セット: `recommended_8`（ohayo, oyasumi, arigato, otsukare, iine, daisuki, gomen, bye）
  - カテゴリは「セットのグループ表示」またはタブで対応。Phase 2 で拡張可
- [x] **ストア**
  - 選択中 wordIds・ZIP 生成中フラグ等を `useLineStampStore` で分離（`app/stores/line-stamp.ts`）

## 5.4 画像生成・出力（Phase 1）

- [x] **AI でスタンプ 1 枚生成**
  - サーバー API（POST /api/line-stamp/generate）で元画像＋1 文言を AI（Gemini 画像生成モデル）に渡し、スタンプ画像を 1 枚生成。Vercel Blob（line_stamps パス）に保存し URL を返す
  - 生成中表示・エラー表示を明確に設計する（数十秒程度の待ち時間を想定）
- [x] **1 枚の PNG ダウンロード**
  - 生成完了後に表示した画像を「画像をダウンロード」で 1 枚の PNG としてダウンロード可能にする

※ Canvas による「元画像＋テキスト重ね」は廃止。ZIP・複数枚は **Phase 2（複数スタンプ自動生成）** で実装。

## 5.5 実装順序の目安（Phase 1）

1. 結果画面に「LINEスタンプ用に作る」ボタンと `/result/line-stamp` 遷移（済）
2. LINEスタンプ作成ページ新設・元画像表示・未設定時リダイレクト（済）
3. 単語プリセットと **1 ワードのみ選択** する UI に変更（セット一括選択は非表示）
4. プレビュー（Canvas グリッド）を廃止し、「スタンプを生成」CTA と生成結果 1 枚表示ブロックを用意
5. API（POST /api/line-stamp/generate）で AI に 1 枚生成させ、生成中表示・完了後の画像表示・1 枚 PNG ダウンロードを実装
6. ストアを単一 wordId・生成中フラグ・生成結果 URL に合わせて見直し

**Phase 2（複数スタンプ自動生成）:** `line-stamp-automation` を利用した複数選択・複数枚 AI 生成・ZIP 一括ダウンロード・メイン/タブ画像同梱・カテゴリ表示

## 5.6 注記「LINEクリエイターズマーケットへの申請はご自身で」の記載場所（確定：A + C）

**採用:** **A + C** で確定。

- **A（LINEスタンプ作成ページ）**  
  「LINEクリエイターズマーケットへの申請はご自身でお願いします」を、`/result/line-stamp` に必ず1回表示する。表示位置はヘッダー直下、または「ZIPでダウンロード」ボタンの上。必要に応じて [LINE Creators Market](https://creator.line.me/ja/) への外部リンク（`target="_blank"` `rel="noopener noreferrer"`）を併記する。
- **C（FAQ）**  
  FAQ に「LINEスタンプの申請はどこでしますか？」を追加する。回答で、申請・審査・販売はユーザー自身が LINE Creators Market で行う旨を記載し、LINE Creators Market のリンクで案内する。

実装タスク: 5.2 に「申請注記の表示」、静的ページ（FAQ）に「LINEスタンプ申請のFAQ項目」を反映済み。

## 5.7 注意事項

- 申請・審査・販売はユーザーが LINE Creators Market で実施。本機能は「スタンプ用画像の準備」まで。申請手順はヘルプまたはリンクで案内
- 既存 UI の変更は結果画面のボタン追加のみ。レイアウト・色・フォント・余白は変更しない（`ui-ux.mdc` 準拠）
- Phase 1 では 1 ワード・1 回の AI 生成のため、料金・レート制限の影響を抑える。生成完了までの待ち時間（数十秒想定）に配慮した UX を設計する
- 将来のサブスク上位プランで、ログイン＋契約者向けにワード制限を解放し、複数枚 AI 生成・ZIP ダウンロードを提供する。サブスク会員でない場合は、結果画面の「LINEスタンプ用に作る」ボタンを非活性にし、本ページ自体への遷移を制限する。

## 5.8 Phase 2（複数スタンプ自動生成）の実装タスク

### 5.8.1 Phase 2 の仕様・制約まとめ

- **対象ユーザー・提供形態**
  - Phase 2 は **ログイン＋サブスク上位プラン** を契約しているユーザーのみ利用可能とする。
  - 非契約ユーザーは結果画面の「LINEスタンプ用に作る」ボタンを非活性にし、本ページの複数スタンプ機能には到達できない。
- **生成枚数と同時生成上限**
  - ユーザーは生成するスタンプ枚数を **8 / 16 / 24 / 32 / 40** から選択でき、**初期値は 8** とする。
  - 1 リクエストあたりの同時生成枚数は **最大 40 枚** とし、選択された文言数が 40 を超えないようにバリデーションを行う。
- **レート制限・コスト保護**
  - 1 ユーザー（`anon_session_id`）あたりの **日次上限は 40 枚 / 日** とし、Supabase のレート制限テーブルで累計生成枚数を管理する。
  - 追加のセーフティネットとして、IP アドレス単位でも **200 枚 / 日** 程度の上限を設け、ボット的な大量リクエストを防ぐ。
- **セット／サブスクとの関係**
  - 推奨セット（例: `recommended_8`）や 16 枚以上の構成セットは、**サブスク会員であればすべての作成パターンを解放**し、追加の利用制限は設けない。
- **失敗時の扱い・再生成方針**
  - 複数スタンプ生成時に一部のスタンプ生成が失敗した場合でも、**成功した画像はそのまま保持し、失敗した文言のみ再生成を試みる**。
  - UI 上では「N 個中 M 個のスタンプ生成に成功しました。残り K 個は再生成をお試しください。」のように、**敬体（です／ます調）**でユーザーに状況を案内する。

- [ ] **1. 仕様・制約の整理**
  - [x] 生成するスタンプ枚数をユーザーが **8 / 16 / 24 / 32 / 40** から選択できるようにし、**初期値は 8** とする（UI 上は **単一選択のラジオボタン** で提供し、NuxtUI の `URadioGroup` コンポーネントを使用する）
  - [ ] 1 リクエストあたりの同時生成枚数上限を **最大 40 枚** に設定し、選択された文言数が 40 を超えないようにバリデーションする
  - [x] 1 ユーザー（anon_session_id）あたりの **日次上限を 40 枚 / 日** とし、Supabase のレート制限テーブル等で累計生成枚数を管理する（例: `generated_stamp_counts` テーブルで `generated_count` を日付単位でカウント）
  - [x] 追加のセーフティネットとして、IP アドレス単位でも **200 枚 / 日** 程度の上限を設け、ボット的な大量リクエストを防ぐ（`rate_limits` テーブル＋ `checkRateLimit` による 24時間あたり200リクエスト制限として実装）
  - [ ] 対応するセット（例: `recommended_8` / 16 枚以上構成）のパターンは、サブスク会員であればすべての作成パターンを解放する前提とし、追加で利用制限条件を設けない
  - [x] 一部スタンプ生成が失敗した場合は、**成功した画像はそのまま保持し、失敗した文言のみ再生成を試みる**方針とし、UI での通知方法を敬体（です／ます調）で定義する  
    - **基本方針:**  
      - 1 回のバッチ生成リクエストで、各文言ごとの生成結果（成功／失敗）を個別に保持する  
      - 成功したスタンプ画像は一覧にそのまま表示し、再生成の対象には含めない  
      - 失敗した文言のみを対象に「失敗したスタンプを再生成する」操作を提供する（ボタン名例: 「失敗したスタンプを再生成する」）
    - **トースト／画面上部の通知文言（例）:**  
      - 全件成功時:  
        - 「N 個すべてのスタンプ生成に成功しました。」  
      - 一部成功時（成功 M 個・失敗 K 個、N = M + K の場合）:  
        - 「N 個中 M 個のスタンプ生成に成功しました。残り K 個のスタンプは、少し時間をおいてから再生成をお試しください。」  
      - 全件失敗時:  
        - 「スタンプの生成に失敗しました。お手数ですが、時間をおいてから再度お試しください。」  
    - **UI 上の表示場所の想定:**  
      - 生成結果一覧グリッドの上部、もしくはページ上部に `UAlert` などの通知コンポーネントを表示する  
      - 通知メッセージは常に敬体（です／ます調）を用い、ユーザーを責めない表現とする

- [ ] **2. ストア・状態管理（`useLineStampStore`）**
  - [x] Phase 2 用に、複数選択前提の state を拡張する  
    - 単一選択用の `selectedWordId: string | null` / `customWord: string` は Phase 1 互換のため維持  
    - 複数プリセット選択用に `selectedWordIds: string[]` を追加（セット一括選択・複数チップ選択と連動）  
    - 複数自由入力を扱うため `customWords: string[]` を追加（空文字は actions 側で除外）  
    - ZIP 同梱の制御用に `includeMainAndTab: boolean` を追加（初期値は `true` とし、仕様上は常にメイン画像・タブ画像を含める想定）  
    - バッチ生成用の getter `effectiveLabelsForBatch: string[]` と、選択有無を判定する `hasBatchSelection: boolean` を追加
  - [ ] 各文言ごとの生成結果（成功／失敗／再試行回数）・メイン画像／タブ画像の状態・ZIP ダウンロード URL・エラーメッセージを管理する state と actions（開始・成功・失敗・失敗分のみ再生成・リセット）を追加する
  - [x] 再試行回数が上限（例: 2回）に達した文言・メイン画像・タブ画像は「最終的に失敗」として扱い、それ以上の自動再生成は行わない（UI 上でも再生成対象外として表示する）

- [ ] **3. 文言選択 UI（複数選択対応）**
  - [ ] `StampPresetSelector.vue` を拡張し、プリセットから複数ワード選択・複数自由入力を許可する（選択上限は上記仕様に従う）
  - [x] セット（例: `recommended_8`）をクリックした際に、セット内の全単語を一括選択／解除できるようにする
  - [ ] サブスク未契約ユーザーについては、結果画面の「LINEスタンプ用に作る」ボタンを非活性にすることで、本ページの複数選択 UI に到達しないようにする

- [ ] **4. API・`line-stamp-automation` 連携（非同期ジョブ）**
  - [ ] 既存の `POST /api/line-stamp/generate` を多文言対応に拡張できるかを検討し、可能な場合は `/generate` をバッチ対応 API として拡張する
  - [ ] `/generate` の拡張が難しい場合は、`line-stamp-automation` の処理を Nitro 側に移植した新規エンドポイント（例: `POST /api/line-stamp/export`）を実装する
  - [ ] バッチ生成 API を **非同期ジョブ方式** とし、呼び出し時にサーバー側でジョブを作成してキューに登録し、`{ job_id: string }` をレスポンスとして返す
  - [ ] `GET /api/line-stamp/export/:job_id`（案）のようなエンドポイントでジョブの進捗・結果（各文言・メイン・タブ画像の成功／失敗・画像 URL・ZIP の署名付き URL 等）を取得できるようにする
  - [ ] 認可ロジックを実装し、Phase 2 のバッチ生成 API はサブスク契約者にのみ利用可能とする

- [ ] **5. 生成結果表示・ZIP ダウンロード UI**
  - [ ] `StampGenerateBlock.vue` を拡張し、複数スタンプ生成時はグリッドレイアウトで生成結果一覧を表示できるようにする（スマートフォンでは **2列グリッド**、PC では横幅に応じて列数を増やす）
  - [ ] 各スタンプ・メイン画像・タブ画像の状態を、一般的なローディングアイコン（スピナー）／成功アイコン／エラーアイコン等で視覚的に区別できるようにする
  - [ ] 失敗した文言のみを対象とした「失敗分を再生成」ボタン、または一覧からの個別再生成操作を提供する
  - [ ] ZIP には常にメイン画像・タブ画像を含める前提とし、その生成・同梱状況も UI 上で分かるようにする
  - [ ] 生成が一部失敗していても、成功した分だけで ZIP ダウンロードできるようにし、その旨を **敬体**（です／ます調）で案内する
  - [ ] 主 CTA を「スタンプを ZIP でダウンロード」とし、ZIP 準備中はローディング状態を表示する

- [ ] **6. テスト・検証**
  - [ ] 文言選択 UI（複数選択・セット一括選択・上限超過時）の挙動を確認する
  - [ ] スマホ（2列）・PC（複数列）での生成結果グリッド表示・状態アイコン表示のレイアウト崩れがないことを確認する
  - [ ] 8 個・16 個など複数パターンでスタンプ生成 → 一部失敗 → 失敗分のみ再生成 → ZIP ダウンロードまでを通しでテストし、LINE 仕様どおりのファイル名・枚数・サイズになっているかを UI 観点で確認する
