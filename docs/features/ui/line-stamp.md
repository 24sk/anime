# LINEスタンプ作成機能

変換済みアイコンを元に **AI で LINE 申請用スタンプ画像を 1 枚生成**し、ダウンロードする機能。Phase 1 では **1 ワードのみ選択**可能。将来のサブスク上位プランで複数ワード選択・複数枚 AI 生成・ZIP 一括ダウンロードを提供予定。

- **仕様書**: [line-stamp-spec.md](../requirements/line-stamp-spec.md)
- **結果画面からの入口**: [結果・プレビュー画面](result.md) のアクションボタン領域に「LINEスタンプ用に作る」ボタンを追加

[← 画面一覧に戻る](../ui-features.md)

---

## フェーズ概要

| フェーズ | ワード選択 | 画像生成 | 出力 |
|----------|------------|----------|------|
| **Phase 1（現行）** | **1 ワードのみ** | AI で 1 枚生成 | 1 枚の PNG ダウンロード |
| **将来（サブスク上位）** | 複数選択可能 | AI で複数枚生成 | ZIP 一括ダウンロード |

---

## 実装タスク一覧（Phase 1）

- [x] **結果画面への入口**
  - 結果画面（`/result`）のアクションボタン領域に「LINEスタンプ用に作る」ボタンを 1 つ追加
  - 配置: 「保存」「Post」の下、または「もう一度作る」の上/下。既存の `UButton`・`rounded-3xl` 等に合わせる
  - クリックで `/result/line-stamp` へ遷移（`NuxtLink` または `navigateTo`）
- [x] **LINEスタンプ作成ページの新設**
  - ルート: `/result/line-stamp`。レイアウトはモバイルファースト 1 カラム、既存の `max-w-md` 等に合わせる
  - ヘッダー: タイトル「LINEスタンプ用に書き出し」（戻るボタンはなし）
  - 元画像なし（`resultImageUrl` 未設定）で直接アクセスされた場合は結果画面へリダイレクト
- [x] **プリセットデータ・型定義**
  - `StampWord`（id, label, group）・`StampSet`（id, name, wordIds, type）・`StampCategory`（id, name, setIds）の型定義
  - 単語プリセット定数: あいさつ・感謝・リアクション・応援・愛情・ごめん・フォロー（仕様 3.2.1 の初期実装分）
  - セット定数: あいさつ・感謝・リアクション・愛情・フォロー・応援、および **おすすめ8個（申請用）**（仕様 3.2.2）
  - おすすめ8個セットは UI で目立つ位置に配置
- [x] **文言選択 UI（単一選択＋自由入力）**
  - プリセット（単語）から **1 ワードのみ** 選択可能。チップまたはカードで単一選択 UI。
  - **ユーザーの自由入力**も可能（1 文言、最大文字数制限あり）。プリセットと自由入力は排他（どちらか一方のみ）。
  - セット一括選択・「おすすめ8個」の一括選択は Phase 1 では提供しない（将来サブスクで解放）。セットタブではセット内の単語を 1 つ選ぶ単一選択として表示。
- [x] **プレビュー廃止・AI 生成フロー**
  - Canvas によるプレビュー表示は **廃止**。代わりに「スタンプを生成」CTA を配置し、AI 生成完了後に **生成結果 1 枚** を表示する。
- [x] **AI でスタンプ 1 枚生成**
  - API（POST /api/line-stamp/generate）で元画像＋1 文言を AI に渡し、スタンプ画像を 1 枚生成。生成中表示・完了後の画像表示・1 枚の PNG ダウンロードを実装。
- [x] **ストア・状態の見直し**
  - 選択は **wordId 1 件または自由入力 1 件**。AI 生成中フラグ・生成結果画像 URL ・エラーメッセージを保持する。
- [x] **申請注記・FAQ**
  - 申請注記は実装済み。FAQ は必要に応じて追加。

※ ZIP ダウンロード・メイン/タブ画像オプション・複数選択は **将来（サブスク上位プラン）** で実装予定。

---

## 5.1 結果画面の変更（入口）

- [x] **「LINEスタンプ用に作る」ボタン**
  - アクションボタン領域に 1 つ追加。配置は「保存」「Post」の下、または「もう一度作る」の上/下
  - `UButton` を使用し、既存の `result.vue` のスタイル（`rounded-3xl` 等）に合わせる
  - クリックで `/result/line-stamp` へ遷移

## 5.2 LINEスタンプ作成ページ（`/result/line-stamp`）

- [x] **ページ骨格・ガード**
  - ルート: `/result/line-stamp`。モバイルファースト 1 カラム、`max-w-md` 等で最大幅を既存に合わせる
  - ヘッダー: タイトル「LINEスタンプ用に書き出し」（戻るボタンはなし）
  - `generationStore.resultImageUrl` が無い場合は結果画面へリダイレクト
- [x] **申請注記の表示**（5.6 確定仕様）
  - ヘッダー直下、または CTA の上に「LINEクリエイターズマーケットへの申請はご自身でお願いします」を1行で表示
  - 必要に応じて LINE Creators Market（https://creator.line.me/ja/）への外部リンクを併記（`<a target="_blank" rel="noopener noreferrer">`）
- [x] **元画像エリア**
  - 完成したアイコン画像のプレビュー（AI 生成の参照元として表示）。`resultImageUrl` を `NuxtImg` で表示
- [x] **文言選択ブロック（単一選択＋自由入力）**
  - 見出し文言: 「テキストを1つ選択してください」
  - タブは初期表示時に **単語** を選択。**セット** タブは Phase 1 では非活性とし、作成中である旨をツールチップで案内。
  - プリセット（単語）から **1 ワードのみ** 選択。チップまたはカードで単一選択 UI。
  - **自由入力欄**（その他）は幅・高さを広めにし入力しやすくする（UTextarea、複数行）。プリセット以外の文言を 1 件入力可能（最大文字数制限あり）。プリセット選択時は自由入力をクリア、自由入力時はプリセット選択をクリア。
  - セット・おすすめ8個は Phase 1 では一括選択ではなく、セット内の単語を 1 つ選ぶ単一選択として表示。
  - ページ専用コンポーネント: `StampPresetSelector.vue`
- [x] **プレビュー廃止・生成結果表示**
  - Canvas プレビューは **廃止**。主 CTA「スタンプを生成」は LINE ブランドカラー（#06C755）で視認性を高めて表示。実行後、AI 生成が完了したら **生成結果 1 枚** を表示するブロック（`StampGenerateBlock.vue`）を用意
- [x] **ダウンロード（Phase 1）**
  - 生成完了後に「画像をダウンロード」で 1 枚の PNG をダウンロード。ZIP は将来（サブスク）で提供

※ オプション（メイン/タブ画像）・ZIP ダウンロードは **将来（サブスク）** で実装。

## 5.3 データ・定数・ストア

- [x] **型定義**
  - `StampWordGroup`（aisatsu, kansha, reaction, oen, ai_follow, gomen_follow 等）
  - `StampWord`（id, label, group）、`StampSet`（id, name, wordIds, type?）、`StampCategory`（id, name, setIds）
  - `StampSetType`: `'required' | 'recommended_8' | 'extended'`
- [x] **単語プリセット定数**
  - 仕様 3.2.1 に基づく単語一覧（あいさつ・感謝・リアクション・応援・愛情・ごめん・フォロー）。初期実装では仕事用・季節は Phase 2
- [x] **セット・カテゴリ定数**
  - 必須セット: あいさつ・感謝・リアクション・愛情・フォロー・応援
  - 推奨8個セット: `recommended_8`（ohayo, oyasumi, arigato, otsukare, iine, daisuki, gomen, bye）
  - カテゴリは「セットのグループ表示」またはタブで対応。Phase 2 で拡張可
- [x] **ストア**
  - 選択中 wordIds・ZIP 生成中フラグ等を `useLineStampStore` で分離（`app/stores/line-stamp.ts`）

## 5.4 画像生成・出力（Phase 1）

- [x] **AI でスタンプ 1 枚生成**
  - サーバー API（POST /api/line-stamp/generate）で元画像＋1 文言を AI（Gemini 画像生成モデル）に渡し、スタンプ画像を 1 枚生成。Vercel Blob（line_stamps パス）に保存し URL を返す
  - 生成中表示・エラー表示を明確に設計する（数十秒程度の待ち時間を想定）
- [x] **1 枚の PNG ダウンロード**
  - 生成完了後に表示した画像を「画像をダウンロード」で 1 枚の PNG としてダウンロード可能にする

※ Canvas による「元画像＋テキスト重ね」は廃止。ZIP・複数枚は **将来（サブスク）** で実装。

## 5.5 実装順序の目安（Phase 1）

1. 結果画面に「LINEスタンプ用に作る」ボタンと `/result/line-stamp` 遷移（済）
2. LINEスタンプ作成ページ新設・元画像表示・未設定時リダイレクト（済）
3. 単語プリセットと **1 ワードのみ選択** する UI に変更（セット一括選択は非表示）
4. プレビュー（Canvas グリッド）を廃止し、「スタンプを生成」CTA と生成結果 1 枚表示ブロックを用意
5. API（POST /api/line-stamp/generate）で AI に 1 枚生成させ、生成中表示・完了後の画像表示・1 枚 PNG ダウンロードを実装
6. ストアを単一 wordId・生成中フラグ・生成結果 URL に合わせて見直し

**将来（サブスク）:** 複数選択・複数枚 AI 生成・ZIP 一括ダウンロード・メイン/タブ画像オプション・カテゴリ表示

## 5.6 注記「LINEクリエイターズマーケットへの申請はご自身で」の記載場所（確定：A + C）

**採用:** **A + C** で確定。

- **A（LINEスタンプ作成ページ）**  
  「LINEクリエイターズマーケットへの申請はご自身でお願いします」を、`/result/line-stamp` に必ず1回表示する。表示位置はヘッダー直下、または「ZIPでダウンロード」ボタンの上。必要に応じて [LINE Creators Market](https://creator.line.me/ja/) への外部リンク（`target="_blank"` `rel="noopener noreferrer"`）を併記する。
- **C（FAQ）**  
  FAQ に「LINEスタンプの申請はどこでしますか？」を追加する。回答で、申請・審査・販売はユーザー自身が LINE Creators Market で行う旨を記載し、LINE Creators Market のリンクで案内する。

実装タスク: 5.2 に「申請注記の表示」、静的ページ（FAQ）に「LINEスタンプ申請のFAQ項目」を反映済み。

## 5.7 注意事項

- 申請・審査・販売はユーザーが LINE Creators Market で実施。本機能は「スタンプ用画像の準備」まで。申請手順はヘルプまたはリンクで案内
- 既存 UI の変更は結果画面のボタン追加のみ。レイアウト・色・フォント・余白は変更しない（`ui-ux.mdc` 準拠）
- Phase 1 では 1 ワード・1 回の AI 生成のため、料金・レート制限の影響を抑える。生成完了までの待ち時間（数十秒想定）に配慮した UX を設計する
- 将来のサブスク上位プランで、ログイン＋契約者向けにワード制限を解放し、複数枚 AI 生成・ZIP ダウンロードを提供する
