# LINEスタンプ作成機能 仕様書

## 1. 概要

### 1.1 目的

変換済みのペットアイコン画像を元に、**AI で LINE クリエイターズスタンプ申請用の画像を生成する**機能を提供する。ユーザーが選んだ文言（例:「おはよう」）に合わせて、AI がスタンプ画像を 1 枚生成し、LINE の画像仕様に合わせて書き出し・ダウンロードできるようにする。

### 1.2 スコープ

| 対象 | 内容 |
|------|------|
| **AniMe で行うこと** | 変換済みアイコンと選択文言を入力として、AI でスタンプ画像を生成し、LINE 仕様サイズの PNG でダウンロード可能にする |
| **ユーザーが行うこと** | ダウンロードした画像を LINE Creators Market にアップロードし、申請・審査・販売設定を行う |

LINEスタンプの申請・審査・公開は LINE のプラットフォーム側で行うため、本機能は「スタンプ用画像の準備」までを担当する。

### 1.3 フェーズと制限（料金・レート制限を考慮）

| フェーズ | ワード選択 | 画像生成方式 | 出力 |
|----------|------------|--------------|------|
| **Phase 1（現行）** | **1 ワードのみ** 選択可能 | 選択した 1 文言に対し **AI で 1 枚** 生成 | 1 枚の PNG ダウンロード |
| **将来（サブスク上位プラン）** | ログイン＋サブスク契約者向けに **ワード制限を解放**（複数選択可） | 選択した複数文言それぞれを **AI で生成** | 複数枚を ZIP で一括ダウンロード |

* 料金・レート制限の影響を抑えるため、Phase 1 では 1 ワード・1 回の AI 生成に限定する。待ち時間の設計（生成中表示など）を明確にする。
* 将来的にログイン機能とサブスクリプション機能をリリースし、上位プラン契約者には複数ワード選択と AI による複数枚スタンプ生成・ZIP ダウンロードを提供する。

### 1.4 関連ドキュメント

* 要件定義: `docs/requirement.md`
* 機能一覧: `docs/features/features.md`
* UI機能詳細: `docs/features/ui-features.md`
* LINE 制作ガイドライン（外部）: [creator.line.me/ja/guideline](https://creator.line.me/ja/guideline/)

---

## 2. LINE 画像仕様（参照）

本機能の出力は、LINEクリエイターズスタンプの制作ガイドラインに準拠する。

| 種類 | サイズ | 枚数 | 形式・備考 |
|------|--------|------|------------|
| スタンプ画像 | 370px × 320px 以下 | 8 / 16 / 24 / 32 / 40 のいずれか | PNG、1枚1MB以下、透過推奨、72dpi以上、RGB |
| メイン画像 | 240px × 240px | 1枚 | スタンプ一覧表示用 |
| トークルームタブ画像 | 96px × 74px | 1枚 | タブ用サムネイル |

* ファイル名: ZIP一括の場合は `01.png`, `02.png` … および `main.png`, `tab.png` を含める。
* 本プロジェクトの生成画像は 1:1（例: 512×512）のため、中央切り出しまたは余白付きで上記サイズに変換する。

---

## 3. 機能要件

### 3.1 入力

| 項目 | 内容 |
|------|------|
| 元画像 | 結果画面で表示している「完成したアイコン画像」1枚（`generationStore.resultImageUrl`）。AI 生成時の参照画像として利用する。 |
| 文言 | プリセット（単語）から **1 ワードのみ** 選択、または **ユーザーの自由入力**で 1 文言を指定（Phase 1）。プリセットと自由入力は排他（どちらか一方のみ）。将来のサブスク上位プランでは複数選択を解放する。 |

### 3.2 文言プリセット

「うちの子」動物スタンプとして、毎日のトークで使いやすく、飼い主が満足しやすい単語・セットを定義する。

* **Phase 1:** 単語を **1 つだけ** 選択し、その 1 文言に対して AI がスタンプ画像を 1 枚生成する。セット・カテゴリの定義は将来の複数選択解放時に利用する。
* **将来（サブスク）:** LINE 申請の最低枚数は **8 個** のため、**推奨「8個セット」** で最小構成を 1 クリックで選べるようにする等、複数選択 UI を提供する。

#### 3.2.1 単語（ワード）

基本の文言を単体で選択できるようにする。**Phase 1 ではいずれか 1 ワードのみ選択可能**とする。分類は UI でのグループ表示やセット定義に利用する。

**あいさつ**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| ohayo | おはよう | |
| oyasumi | おやすみ | |
| konnichiwa | こんにちは | |
| bye | バイバイ | |
| tadaima | ただいま | |
| okaeri | おかえり | |

**感謝・ねぎらい**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| arigato | ありがとう | |
| thanks | Thanks | カジュアルな感謝 |
| otsukare | おつかれさま | |
| tasukatta | 助かった | |

**リアクション**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| iine | いいね！ | |
| wakatta | わかった | |
| ryokai | 了解 | |
| ok | OK | |
| yatta | やったー | |
| ee | えー！ | |

**応援・励まし**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| ganbare | がんばれ | |
| fight | ファイト | |
| daijobu | 大丈夫 | |
| murishinaide | 無理しないで | |

**愛情**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| daisuki | だいすき | |
| kawaii | かわいい | |
| iiko | いい子 | |
| chu | チュー | |

**ごめん・フォロー**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| gomen | ごめんね | |
| okurete_gomen | 遅れてごめん | |
| otto | おっと | |
| doki | ドキッ | |

**仕事用（オプション・Phase 2 でも可）**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| ryokai_desu | 了解です | |
| shochi_shimashita | 承知しました | |
| osaki_shitsurei | お先に失礼します | |
| ashita_yoroshiku | 明日もよろしく | |

**季節・イベント（Phase 2）**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| merry_xmas | メリークリスマス | |
| akemashite | あけましておめでとう | |
| happy_valentine | ハッピーバレンタイン | |
| tanjoubi_omedetou | 誕生日おめでとう | |

※ 初期実装では「あいさつ」「感謝」「リアクション」「愛情」「ごめん・フォロー」「応援」までを対象とし、仕事用・季節は Phase 2 で追加する。

#### 3.2.2 セット

複数の単語をまとめたグループ。**将来（サブスク）**では、セットを選ぶとそのセットに含まれる全単語が一括で選択された状態になる。Phase 1 では単一ワード選択のため、セットの一括選択は提供しない（定義のみ残す）。

**必須セット（初期実装で提供）**

| セットID | 表示名 | 含まれる単語（word IDs） | 想定シーン |
|----------|--------|---------------------------|------------|
| aisatsu | あいさつ | ohayo, oyasumi, konnichiwa, bye, tadaima, okaeri | 家族・友達との日常 |
| kansha | 感謝 | arigato, thanks, otsukare, tasukatta | お礼・ねぎらい |
| reaction | リアクション | iine, wakatta, ryokai, ok, yatta, ee | メッセージへの返事 |
| ai_follow | 愛情・フォロー | daisuki, kawaii, iiko, chu, gomen, okurete_gomen, otto, doki | 愛情表現・謝罪・フォロー |
| oen | 応援 | ganbare, fight, daijobu, murishinaide | 励まし・気遣い |

**推奨「8個セット」（LINE申請の最小構成）**

申請に必要な最低 8 個を、バランスよく 1 セットにしたもの。デフォルトで選択可能にし、「このセットだけで申請できる」と分かりやすくする。

| セットID | 表示名 | 含まれる単語（word IDs） | 備考 |
|----------|--------|---------------------------|------|
| recommended_8 | おすすめ8個（申請用） | ohayo, oyasumi, arigato, otsukare, iine, daisuki, gomen, bye | あいさつ・感謝・リアクション・愛情・謝罪を網羅した最小セット |

**拡張セット（Phase 2）**

| セットID | 表示名 | 含まれる単語（word IDs） | 想定シーン |
|----------|--------|---------------------------|------------|
| work | 仕事用 | ryokai_desu, shochi_shimashita, osaki_shitsurei, ashita_yoroshiku, otsukare, arigato, ... | 社内・取引先のカジュアルなやりとり |
| seasonal | 季節・イベント | merry_xmas, akemashite, happy_valentine, tanjoubi_omedetou | 年賀・クリスマス・誕生日など |

#### 3.2.3 カテゴリ

セットをまとめた区分。UI で「カテゴリ → セット → 単語」とたどれるようにする。

| カテゴリID | 表示名 | 含まれるセット | 備考 |
|------------|--------|----------------|------|
| daily | 毎日使える | aisatsu, kansha, reaction, ai_follow, oen | 必須セットのグループ。初期実装で表示 |
| recommended | はじめての申請 | recommended_8 | 推奨8個のみ。目立つ位置に配置を推奨 |
| extended | もっと使う | work, seasonal | Phase 2 で追加 |

※ 初期実装では「単語」と「セット」を優先し、カテゴリは「セットのグループ表示」またはタブ切り替えで対応してもよい。

### 3.3 出力

| フェーズ | 項目 | 内容 |
|----------|------|------|
| **Phase 1** | スタンプ画像 | 選択した **1 文言** に対し、**AI が生成した**スタンプ画像を **370×320** 以内（または 240×240）で 1 枚出力。単体 PNG でダウンロード。 |
| **Phase 1** | 配布形式 | **1 枚の PNG ダウンロード**（ZIP は対象外）。 |
| **将来（サブスク）** | スタンプ画像 | 選択した複数文言それぞれに対し、AI が生成。ファイル名は `01.png`, `02.png` … |
| **将来（サブスク）** | メイン・タブ画像 | 元画像を 240×240 / 96×74 にリサイズ。オプションで ZIP に含める。 |
| **将来（サブスク）** | 配布形式 | 複数枚の PNG を **ZIP で一括ダウンロード**。 |

### 3.4 非機能要件

* **Phase 1:** 1 ワード・1 回の AI 生成のため、料金・レート制限の影響を最小化する。生成完了まで数十秒程度を想定し、**待ち時間の設計**（生成中表示・進捗やキャンセル等）を明確にする。
* **将来（サブスク）:** 複数枚の AI 生成を行うため、同時生成枚数上限（例: 40 枚）やレート制限・コスト管理を設ける。
* **互換性:** LINE の仕様変更に合わせて、出力サイズ・ファイル名ルールを仕様書と実装で更新できるようにする。

---

## 4. 画面・UI 仕様

### 4.1 結果画面（`/result`）の変更

* **追加要素:** アクションボタン領域に「LINEスタンプ用に作る」ボタンを 1 つ追加する。
* **配置:** 「保存」「Post」の下、「もう一度作る」の上、または「もう一度作る」の下のいずれか。デザインルールに従い、既存のボタンと視覚的階層を揃える。
* **動作:** クリックで LINE スタンプ作成ページへ遷移する。遷移先では `generationStore.resultImageUrl` を参照して元画像を表示・処理する。
* **ガイドライン:** NuxtUI の `UButton` を使用し、既存の `result.vue` のスタイル（`rounded-3xl` 等）に合わせる。

### 4.2 LINEスタンプ作成ページ（新規）

* **ルート:** `/result/line-stamp` または `/line-stamp`。result から遷移する場合は `/result/line-stamp` で、元画像は Pinia から取得する想定とする。
* **レイアウト:** モバイルファーストの 1 カラム。最大幅は既存レイアウト（例: `max-w-md`）に合わせる。

#### 4.2.1 構成要素

| ブロック | Phase 1（現行） | 将来（サブスク） |
|----------|-----------------|------------------|
| ヘッダー | 「戻る」リンク（結果画面へ）、タイトル「LINEスタンプ用に書き出し」 | 同左 |
| 元画像エリア | 完成したアイコン画像のプレビュー（AI 生成の参照元として表示） | 同左 |
| 文言選択 | プリセット（単語）から **1 ワードのみ** 選択。**自由入力**で 1 文言の指定も可能。チップまたはカードで単一選択 UI。セット・カテゴリタブは単語の単一選択として表示 | 複数選択可能。セット・カテゴリで一括選択を提供。「おすすめ8個」等を目立たせる |
| プレビュー | **廃止**。代わりに「スタンプを生成」実行後、**AI 生成結果 1 枚**を表示する | 複数枚の生成結果をグリッド等で表示 |
| オプション | 対象外（1 枚のため） | チェックボックス「メイン画像・タブ画像もZIPに含める」 |
| ダウンロード | 主 CTA「スタンプを生成」→ 生成完了後「画像をダウンロード」（1 枚の PNG） | 主 CTA「ZIPでダウンロード」。生成完了後に一括ダウンロード |

#### 4.2.2 遷移・ガード

* 元画像（`resultImageUrl`）が存在しない状態で本ページに直接アクセスした場合は、結果画面またはトップへリダイレクトする。
* ブラウザバック時は、結果画面に戻る。必要に応じて「もう一度作る」と同様のガードを検討する。

#### 4.2.3 コンポーネント配置方針

* **Phase 1:** ページ専用コンポーネントは `components/pages/line-stamp/` に配置。文言選択は **単一選択** 用の UI（例: `StampPresetSelector.vue` を単一選択に変更）。プレビューグリッドは廃止し、AI 生成結果 1 枚を表示するブロックを用意する。
* **将来:** 複数選択・複数枚生成結果表示・ZIP ダウンロード用のコンポーネントを追加する。
* 共通コンポーネント: 既存の `common/` を流用し、新規は必要最小限とする。

---

## 5. データ・定数定義

### 5.1 プリセットデータ（フロントエンド）

初期実装では TypeScript の定数として保持する。将来的に API または CMS で差し替え可能にしてもよい。単語・セット・カテゴリの具体値は **3.2 文言プリセット** に従う。

```ts
// 単語の分類（UI のグループ表示・セット定義に利用）
type StampWordGroup =
  | 'aisatsu' | 'kansha' | 'reaction' | 'oen' | 'ai_follow' | 'gomen_follow'
  | 'work' | 'seasonal'

// 単語プリセット
interface StampWord {
  id: string
  label: string        // 表示用（例: おはよう）
  group: StampWordGroup // あいさつ / 感謝 / リアクション など
}

// セット種別（推奨8個は UI で目立たせる等に利用）
type StampSetType = 'required' | 'recommended_8' | 'extended'

// セット
interface StampSet {
  id: string
  name: string       // 表示名（例: あいさつ / おすすめ8個（申請用））
  wordIds: string[]
  type?: StampSetType // required | recommended_8 | extended
}

// カテゴリ
interface StampCategory {
  id: string
  name: string   // 表示名（例: 毎日使える）
  setIds: string[]
}
```

### 5.2 ストア

* 既存の `useGenerationStore` の `resultImageUrl` をそのまま利用する。
* LINE スタンプ専用の状態は `useLineStampStore` 等で管理する。
  * **Phase 1:** 選択は **プリセット wordId 1 件** または **自由入力 1 文言** のいずれか（単一選択）。AI 生成中フラグ・生成結果画像 URL 等を保持する。実際に使用する文言は getter（例: effectiveLabel）でプリセット label または自由入力を返す。
  * **将来:** 選択中の wordIds（複数）、ZIP 生成中フラグ、生成結果の一覧等を保持する。

---

## 6. 技術方針

### 6.1 スタンプ画像の生成方式

* **Phase 1（現行）:** **AI（Gemini Imagen 等）** でスタンプ画像を **1 枚** 生成する。
  * 入力: 変換済みアイコン画像（`resultImageUrl`）＋ 選択した **1 文言**（wordId に対応する label）。
  * 既存のペットアイコン生成と同様、サーバー（Nitro）で AI API を呼び出し、生成画像を Vercel Blob 等に保存して URL を返す。クライアントはその URL を表示し、1 枚の PNG としてダウンロード可能にする。
  * メリット: 文言に合わせた表現・レイアウトを AI に任せられ、面白みのあるスタンプになる。料金・レート制限は 1 回/1 ユーザーあたりに抑えられる。
  * 待ち時間: 数十秒程度を想定。生成中表示・進捗やエラー表示を明確に設計する。
* **将来（サブスク）:** 複数文言それぞれに対して AI を呼び出し、複数枚を生成。ZIP で一括ダウンロードする。同時生成枚数上限・レート制限を設ける。

※ クライアント Canvas による「元画像＋テキスト重ね」方式は採用しない（仕様変更により廃止）。

### 6.2 出力サイズ・ZIP

* **Phase 1:** 生成された画像を LINE 仕様（370×320 以内または 240×240）にリサイズする処理をサーバーまたはクライアントで行う。配布は **1 枚の PNG ダウンロード** のみ。
* **将来:** クライアントで **JSZip** 等を用い、複数枚の PNG を ZIP にまとめてダウンロード。ファイル名は `01.png` 〜、メイン/タブ画像は `main.png`, `tab.png` とする。

---

## 7. API

### 7.1 Phase 1 で必要な API

* **POST /api/line-stamp/generate**（案）
  * Request: `{ image_url: string, word_id?: string, custom_label?: string }`（word_id と custom_label のどちらか一方。プリセット選択時は word_id、自由入力時は custom_label を送る。1 文言のみ）
  * 処理: 元画像と文言（プリセットの label または custom_label）を AI（Gemini Imagen 等）に渡し、スタンプ画像を 1 枚生成。LINE 仕様サイズにリサイズし、Vercel Blob 等に保存。
  * Response: `{ result_image_url: string }` またはエラー。レート制限は既存の画像生成と同様に IP または anon_session_id 単位で考慮する。

### 7.2 将来（サブスク）で検討する API

* **POST /api/line-stamp/export**（案）
  * Request: `{ image_url: string, word_ids: string[], include_main_and_tab: boolean }`
  * Response: ZIP のバイナリ、または署名付き URL。認可はサブスク契約者に限定する。

---

## 8. 実装ステップ（優先順）

### Phase 1（現行）

| 順序 | 内容 |
|------|------|
| 1 | 結果画面に「LINEスタンプ用に作る」ボタンを追加し、新ページ `/result/line-stamp` へ遷移させる |
| 2 | LINE スタンプ作成ページを新設。元画像は Pinia の `resultImageUrl` を表示。未設定時は結果画面へリダイレクト |
| 3 | 単語プリセットの定数と、**1 ワードのみ選択**する UI（チップまたはカードで単一選択）を実装。セット一括選択は提供しない |
| 4 | **AI でスタンプ 1 枚を生成**する API（例: POST /api/line-stamp/generate）を実装。元画像＋1 文言を入力に AI を呼び出し、結果を Blob 等に保存して URL を返す |
| 5 | 生成中表示・完了後の **生成結果 1 枚の表示** と **1 枚の PNG ダウンロード** を実装。プレビューグリッドは廃止 |

### 将来（サブスク上位プラン）

| 順序 | 内容 |
|------|------|
| 6 | ログイン・サブスク機能をリリース。上位プランで **ワード制限を解放**（複数選択可能に） |
| 7 | 複数文言それぞれを AI で生成。生成結果をグリッド表示し、**ZIP で一括ダウンロード**（JSZip）。セット選択・メイン/タブ画像オプションを提供 |
| 8 | カテゴリ表示（セットのグループ化）は必要に応じて追加 |

---

## 9. 注意事項・制約

* **申請はユーザーが実施:** LINE Creators Market への申請・審査・販売はユーザー自身が行う。本機能では「LINE申請の手順」をヘルプまたはリンクで案内するにとどめる。
* **AI 生成の品質・ポリシー:** スタンプ画像は AI が生成するため、既存のペットアイコン生成と同様にセーフティフィルタ・コンテンツポリシーを考慮する。不適切な出力の場合はエラーとして扱い、ユーザーに別の文言を促す。
* **既存 UI の変更:** 結果画面のボタン追加を除き、既存のレイアウト・色・フォント・余白は変更しない。デザインルール（`design-rules.mdc`, `ui-ux.mdc`）に従う。

---

## 10. ドキュメント更新

本機能の実装・変更に合わせて、以下を更新する。

* **機能一覧:** `docs/features/features.md` に「LINEスタンプ用画像準備」を追加し、本仕様書への参照を記載する。
* **UI 機能詳細:** `docs/features/ui-features.md` に画面構成・コンポーネントを追記する。
* **API 設計:** サーバー側で画像処理 API を追加する場合、`docs/designs/api-design.md` にエンドポイントを記載する。
