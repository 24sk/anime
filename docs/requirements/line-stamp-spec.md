# LINEスタンプ作成機能 仕様書

## 1. 概要

### 1.1 目的

変換済みのペットアイコン画像を用いて、**LINEクリエイターズスタンプ申請用の画像を準備する**機能を提供する。ユーザーが「おはよう」「おやすみ」などのテキストを重ねた画像を、LINEの画像仕様に合わせて書き出し、ダウンロードできるようにする。

### 1.2 スコープ

| 対象 | 内容 |
|------|------|
| **AniMe で行うこと** | 変換済みアイコンに文言を重ね、LINE仕様サイズで画像を生成し、PNG/ZIPでダウンロード可能にする |
| **ユーザーが行うこと** | ダウンロードした画像を LINE Creators Market にアップロードし、申請・審査・販売設定を行う |

LINEスタンプの申請・審査・公開は LINE のプラットフォーム側で行うため、本機能は「スタンプ用画像の準備」までを担当する。

### 1.3 関連ドキュメント

* 要件定義: `docs/requirement.md`
* 機能一覧: `docs/features/features.md`
* UI機能詳細: `docs/features/ui-features.md`
* LINE 制作ガイドライン（外部）: [creator.line.me/ja/guideline](https://creator.line.me/ja/guideline/)

---

## 2. LINE 画像仕様（参照）

本機能の出力は、LINEクリエイターズスタンプの制作ガイドラインに準拠する。

| 種類 | サイズ | 枚数 | 形式・備考 |
|------|--------|------|------------|
| スタンプ画像 | 370px × 320px 以下 | 8 / 16 / 24 / 32 / 40 のいずれか | PNG、1枚1MB以下、透過推奨、72dpi以上、RGB |
| メイン画像 | 240px × 240px | 1枚 | スタンプ一覧表示用 |
| トークルームタブ画像 | 96px × 74px | 1枚 | タブ用サムネイル |

* ファイル名: ZIP一括の場合は `01.png`, `02.png` … および `main.png`, `tab.png` を含める。
* 本プロジェクトの生成画像は 1:1（例: 512×512）のため、中央切り出しまたは余白付きで上記サイズに変換する。

---

## 3. 機能要件

### 3.1 入力

| 項目 | 内容 |
|------|------|
| 元画像 | 結果画面で表示している「完成したアイコン画像」1枚（`generationStore.resultImageUrl`） |
| 文言 | プリセット（単語）またはセット・カテゴリで選択。任意でカスタム文言を1件追加可能とするかは Phase 2 で検討 |

### 3.2 文言プリセット

「うちの子」動物スタンプとして、毎日のトークで使いやすく、飼い主が満足しやすい単語・セットを定義する。LINE申請の最低枚数は **8 個** のため、**推奨「8個セット」** で最小構成を1クリックで選べるようにする。

#### 3.2.1 単語（ワード）

基本の文言を単体で選択できるようにする。分類はUIでのグループ表示やセット定義に利用する。

**あいさつ**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| ohayo | おはよう | |
| oyasumi | おやすみ | |
| konnichiwa | こんにちは | |
| bye | バイバイ | |
| tadaima | ただいま | |
| okaeri | おかえり | |

**感謝・ねぎらい**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| arigato | ありがとう | |
| thanks | Thanks | カジュアルな感謝 |
| otsukare | おつかれさま | |
| tasukatta | 助かった | |

**リアクション**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| iine | いいね！ | |
| wakatta | わかった | |
| ryokai | 了解 | |
| ok | OK | |
| yatta | やったー | |
| ee | えー！ | |

**応援・励まし**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| ganbare | がんばれ | |
| fight | ファイト | |
| daijobu | 大丈夫 | |
| murishinaide | 無理しないで | |

**愛情**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| daisuki | だいすき | |
| kawaii | かわいい | |
| iiko | いい子 | |
| chu | チュー | |

**ごめん・フォロー**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| gomen | ごめんね | |
| okurete_gomen | 遅れてごめん | |
| otto | おっと | |
| doki | ドキッ | |

**仕事用（オプション・Phase 2 でも可）**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| ryokai_desu | 了解です | |
| shochi_shimashita | 承知しました | |
| osaki_shitsurei | お先に失礼します | |
| ashita_yoroshiku | 明日もよろしく | |

**季節・イベント（Phase 2）**

| ID | 表示テキスト | 備考 |
|----|--------------|------|
| merry_xmas | メリークリスマス | |
| akemashite | あけましておめでとう | |
| happy_valentine | ハッピーバレンタイン | |
| tanjoubi_omedetou | 誕生日おめでとう | |

※ 初期実装では「あいさつ」「感謝」「リアクション」「愛情」「ごめん・フォロー」「応援」までを対象とし、仕事用・季節は Phase 2 で追加する。

#### 3.2.2 セット

複数の単語をまとめたグループ。セットを選ぶと、そのセットに含まれる全単語が一括で選択された状態になる。

**必須セット（初期実装で提供）**

| セットID | 表示名 | 含まれる単語（word IDs） | 想定シーン |
|----------|--------|---------------------------|------------|
| aisatsu | あいさつ | ohayo, oyasumi, konnichiwa, bye, tadaima, okaeri | 家族・友達との日常 |
| kansha | 感謝 | arigato, thanks, otsukare, tasukatta | お礼・ねぎらい |
| reaction | リアクション | iine, wakatta, ryokai, ok, yatta, ee | メッセージへの返事 |
| ai_follow | 愛情・フォロー | daisuki, kawaii, iiko, chu, gomen, okurete_gomen, otto, doki | 愛情表現・謝罪・フォロー |
| oen | 応援 | ganbare, fight, daijobu, murishinaide | 励まし・気遣い |

**推奨「8個セット」（LINE申請の最小構成）**

申請に必要な最低 8 個を、バランスよく 1 セットにしたもの。デフォルトで選択可能にし、「このセットだけで申請できる」と分かりやすくする。

| セットID | 表示名 | 含まれる単語（word IDs） | 備考 |
|----------|--------|---------------------------|------|
| recommended_8 | おすすめ8個（申請用） | ohayo, oyasumi, arigato, otsukare, iine, daisuki, gomen, bye | あいさつ・感謝・リアクション・愛情・謝罪を網羅した最小セット |

**拡張セット（Phase 2）**

| セットID | 表示名 | 含まれる単語（word IDs） | 想定シーン |
|----------|--------|---------------------------|------------|
| work | 仕事用 | ryokai_desu, shochi_shimashita, osaki_shitsurei, ashita_yoroshiku, otsukare, arigato, ... | 社内・取引先のカジュアルなやりとり |
| seasonal | 季節・イベント | merry_xmas, akemashite, happy_valentine, tanjoubi_omedetou | 年賀・クリスマス・誕生日など |

#### 3.2.3 カテゴリ

セットをまとめた区分。UI で「カテゴリ → セット → 単語」とたどれるようにする。

| カテゴリID | 表示名 | 含まれるセット | 備考 |
|------------|--------|----------------|------|
| daily | 毎日使える | aisatsu, kansha, reaction, ai_follow, oen | 必須セットのグループ。初期実装で表示 |
| recommended | はじめての申請 | recommended_8 | 推奨8個のみ。目立つ位置に配置を推奨 |
| extended | もっと使う | work, seasonal | Phase 2 で追加 |

※ 初期実装では「単語」と「セット」を優先し、カテゴリは「セットのグループ表示」またはタブ切り替えで対応してもよい。

### 3.3 出力

| 項目 | 内容 |
|------|------|
| スタンプ画像 | 選択した文言ごとに「元画像＋テキスト」を合成し、**370×320** 以内（または 240×240 に収める）で出力。ファイル名は `01.png`, `02.png` … |
| メイン画像 | 元画像を **240×240** にリサイズ（スタンプ用とは別ファイル）。オプションで ZIP に含める |
| タブ画像 | 元画像を **96×74** にリサイズ。オプションで ZIP に含める |
| 配布形式 | 選択した枚数分の PNG を **ZIP で一括ダウンロード**。必要に応じて「1枚ずつ PNG ダウンロード」も提供 |

### 3.4 非機能要件

* **パフォーマンス:** クライアントで Canvas を用いる場合、同時に生成する枚数が多くなりすぎないよう、上限（例: 40 枚）を設ける。
* **互換性:** LINE の仕様変更に合わせて、出力サイズ・ファイル名ルールを仕様書と実装で更新できるようにする。
* **フォント:** テキスト描画に使用するフォントは、利用許諾と表示品質を確認した上で選定する（例: Noto Sans JP）。クライアント描画の場合は Web フォントの読み込みに留意する。

---

## 4. 画面・UI 仕様

### 4.1 結果画面（`/result`）の変更

* **追加要素:** アクションボタン領域に「LINEスタンプ用に作る」ボタンを 1 つ追加する。
* **配置:** 「保存」「Post」の下、「もう一度作る」の上、または「もう一度作る」の下のいずれか。デザインルールに従い、既存のボタンと視覚的階層を揃える。
* **動作:** クリックで LINE スタンプ作成ページへ遷移する。遷移先では `generationStore.resultImageUrl` を参照して元画像を表示・処理する。
* **ガイドライン:** NuxtUI の `UButton` を使用し、既存の `result.vue` のスタイル（`rounded-3xl` 等）に合わせる。

### 4.2 LINEスタンプ作成ページ（新規）

* **ルート:** `/result/line-stamp` または `/line-stamp`。result から遷移する場合は `/result/line-stamp` で、元画像は Pinia から取得する想定とする。
* **レイアウト:** モバイルファーストの 1 カラム。最大幅は既存レイアウト（例: `max-w-md`）に合わせる。

#### 4.2.1 構成要素

| ブロック | 内容 |
|----------|------|
| ヘッダー | 「戻る」リンク（結果画面へ）、タイトル「LINEスタンプ用に書き出し」 |
| 元画像エリア | 完成したアイコン画像のプレビュー（小さめのサムネイルで十分） |
| 文言選択 | 「単語」「セット」「カテゴリ」のタブまたは切り替え。**推奨「8個セット」**は目立つ位置に配置し、初回でも申請に必要な最小構成を1クリックで選べるようにする。選択可能なプリセットをチップまたはカードで表示し、複数選択可能にする |
| プレビュー | 選択した文言を重ねたスタンプ画像のプレビュー（グリッドまたは横スクロール）。選択解除時は該当プレビューを削除 |
| オプション | チェックボックス「メイン画像・タブ画像もZIPに含める（LINE申請用）」 |
| ダウンロード | 主 CTA「ZIPでダウンロード」。必要に応じて「選択したものをダウンロード」等の副アクション |

#### 4.2.2 遷移・ガード

* 元画像（`resultImageUrl`）が存在しない状態で本ページに直接アクセスした場合は、結果画面またはトップへリダイレクトする。
* ブラウザバック時は、結果画面に戻る。必要に応じて「もう一度作る」と同様のガードを検討する。

#### 4.2.3 コンポーネント配置方針

* ページ専用コンポーネント: `components/pages/line-stamp/` に配置（例: `StampPresetSelector.vue`, `StampPreviewGrid.vue`）。
* 共通コンポーネント: 既存の `common/` を流用し、新規は必要最小限とする。

---

## 5. データ・定数定義

### 5.1 プリセットデータ（フロントエンド）

初期実装では TypeScript の定数として保持する。将来的に API または CMS で差し替え可能にしてもよい。単語・セット・カテゴリの具体値は **3.2 文言プリセット** に従う。

```ts
// 単語の分類（UI のグループ表示・セット定義に利用）
type StampWordGroup =
  | 'aisatsu' | 'kansha' | 'reaction' | 'oen' | 'ai_follow' | 'gomen_follow'
  | 'work' | 'seasonal'

// 単語プリセット
interface StampWord {
  id: string
  label: string        // 表示用（例: おはよう）
  group: StampWordGroup // あいさつ / 感謝 / リアクション など
}

// セット種別（推奨8個は UI で目立たせる等に利用）
type StampSetType = 'required' | 'recommended_8' | 'extended'

// セット
interface StampSet {
  id: string
  name: string       // 表示名（例: あいさつ / おすすめ8個（申請用））
  wordIds: string[]
  type?: StampSetType // required | recommended_8 | extended
}

// カテゴリ
interface StampCategory {
  id: string
  name: string   // 表示名（例: 毎日使える）
  setIds: string[]
}
```

### 5.2 ストア

* 既存の `useGenerationStore` の `resultImageUrl` をそのまま利用する。
* LINE スタンプ専用の状態（選択中の wordIds、ZIP 生成中フラグ等）は、同じストアに追加するか、`useLineStampStore` のような小さいストアに分離する。実装時に判断する。

---

## 6. 技術方針

### 6.1 画像合成・リサイズ

* **Phase 1（推奨）:** **クライアント（Canvas）** で実装する。
  * 元画像を `drawImage` で描画し、テキストを重ねたうえで、LINE 仕様サイズにリサイズして Blob 化する。
  * メリット: サーバー負荷なし、ストレージ不要、実装が比較的単純。
  * 注意: 元画像が別オリジン（Vercel Blob 等）の場合は CORS 対応（`crossOrigin` 設定や、必要に応じて API 経由で Blob 取得）を行う。
* **Phase 2（オプション）:** 品質・統一性をさらに高める場合、**サーバー（Nitro + Sharp 等）** で画像処理 API を用意し、クライアントはその API を呼び出す形に拡張する。Vercel の実行時間・メモリ制限に留意する。

### 6.2 ZIP 生成

* クライアントで **JSZip** 等を用い、生成した PNG Blob を ZIP にまとめてダウンロードする。
* ファイル名: スタンプ画像は `01.png` 〜、メイン画像は `main.png`、タブ画像は `tab.png` とする（LINE の ZIP アップロード仕様に合わせる）。

### 6.3 フォント

* テキスト描画に使用するフォントは、プロジェクトで利用している **Noto Sans JP** を優先して検討する。利用許諾と Canvas 上での表示を確認する。
* クライアント描画の場合、Web フォントの読み込み完了後に Canvas 描画を行う。

---

## 7. API（必要になった場合）

現時点ではクライアント完結を想定し、新規 API は定義しない。サーバー側で画像処理を実装する場合は、以下のようなエンドポイントを追加する。

* **POST /api/line-stamp/export**（案）
  * Request: `{ image_url: string, word_ids: string[], include_main_and_tab: boolean }`
  * Response: ZIP のバイナリ、または署名付き URL。
  * レート制限・認可は既存方針に合わせる。

※ 上記は将来拡張用のメモであり、Phase 1 では実装しない。

---

## 8. 実装ステップ（優先順）

| 順序 | 内容 |
|------|------|
| 1 | 結果画面に「LINEスタンプ用に作る」ボタンを追加し、新ページ `/result/line-stamp` へ遷移させる |
| 2 | LINE スタンプ作成ページを新設。元画像は Pinia の `resultImageUrl` を表示。未設定時は結果画面へリダイレクト |
| 3 | 単語プリセット（おはよう・おやすみ等）の定数と、単語選択 UI（チップまたはカード）を実装 |
| 4 | クライアント Canvas で「画像＋テキスト」を描画し、370×320（または 240×240）にリサイズして Blob 化する処理を実装 |
| 5 | 複数枚を ZIP にまとめてダウンロード（JSZip）。ファイル名を 01.png, 02.png … に統一 |
| 6 | セット（あいさつ・感謝等）を定義し、セット選択で複数単語を一括選択できるようにする |
| 7 | オプションでメイン画像（240×240）・タブ画像（96×74）を生成し、ZIP に `main.png`, `tab.png` として含める |
| 8 | カテゴリ表示（セットのグループ化）は必要に応じて Phase 2 で追加 |

---

## 9. 注意事項・制約

* **申請はユーザーが実施:** LINE Creators Market への申請・審査・販売はユーザー自身が行う。本機能では「LINE申請の手順」をヘルプまたはリンクで案内するにとどめる。
* **CORS:** 元画像が Vercel Blob 等の別オリジンの場合、Canvas で `drawImage` する際に CORS エラーが出る可能性がある。画像取得を自前 API 経由にする、または Blob の CORS 設定を確認する。
* **フォントライセンス:** スタンプ画像に重ねるテキストに使用するフォントの利用許諾を満たすこと。
* **既存 UI の変更:** 結果画面のボタン追加を除き、既存のレイアウト・色・フォント・余白は変更しない。デザインルール（`design-rules.mdc`, `ui-ux.mdc`）に従う。

---

## 10. ドキュメント更新

本機能の実装・変更に合わせて、以下を更新する。

* **機能一覧:** `docs/features/features.md` に「LINEスタンプ用画像準備」を追加し、本仕様書への参照を記載する。
* **UI 機能詳細:** `docs/features/ui-features.md` に画面構成・コンポーネントを追記する。
* **API 設計:** サーバー側で画像処理 API を追加する場合、`docs/designs/api-design.md` にエンドポイントを記載する。
