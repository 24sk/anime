# バイブコーディング標準フロー

このスキルは、AIアシスタントとのペアプログラミング（バイブコーディング）において、安定した実装を実現するための標準化されたフローを定義します。**必ずこの順序で実行することで、事故率を激減させ、高品質なコードを効率的に生成できます。**

## 使用タイミング

- 新規機能の実装時
- 既存機能の修正・改善時
- リファクタリング時
- バグ修正時

## Instructions

以下の8つのステップを**必ずこの順序で実行**してください。各ステップをスキップせず、前のステップが完了してから次のステップに進んでください。

### 1. タスク理解（要約＋前提確認）

**目的**: タスクの全体像を把握し、実装の前提条件を明確にする

**実行内容**:

- ユーザーの指示を分析し、以下の項目を箇条書きで明確にする：
  - **目的**: 何を実現するか
  - **スコープ**: 実装範囲と対象
  - **受け入れ条件**: 完了の判断基準
  - **リスク**: 潜在的な問題や制約
- 関連するルールファイル（`.cursor/rules/dev-rules/*.mdc`）を自動的に参照する
- 関連するドキュメントファイル（`docs/*.md`）を確認する
  - `docs/api-design.md`: API設計ドキュメント（API変更時）
  - `docs/database-design.md`: データベース設計ドキュメント（DB変更時）
  - `docs/ui-implementation-tasks.md`: UI実装タスクリスト（UI実装時）
  - `docs/implementation-tasks.md`: 実装タスクリスト
  - その他関連する設計ドキュメント
- 既存コードベースとの整合性を確認する
- 重複実装の可能性をチェックする

**出力形式**:

```markdown
## タスク理解

### 目的
[タスクの目的を簡潔に記述]

### スコープ
- [実装範囲1]
- [実装範囲2]

### 受け入れ条件
- [条件1]
- [条件2]

### リスク
- [リスク1]: [対策]
- [リスク2]: [対策]

### 関連ルール
- `dev-rules/[ルール名].mdc`: [関連内容]

### 関連ドキュメント
- `docs/[ドキュメント名].md`: [関連内容]
  - 例: `docs/api-design.md`: API設計の確認
  - 例: `docs/database-design.md`: DB設計の確認
  - 例: `docs/ui-implementation-tasks.md`: UI実装タスクの確認
```

### 2. 質問・懸念点整理（最大5個まで）

**目的**: 不明点を早期に特定し、実装の方向性を明確にする

**実行内容**:

- 不明点や曖昧な要件を最大5個までリストアップする
- 各質問に対して、可能な限り仮定を明記する
- 不明点が多い場合でも、勝手に範囲を広げず「仮定して進める」ことを明記する
- 実装前に承認が必要な判断事項を提示する

**出力形式**:

```markdown
## 質問・懸念点整理

### 確認事項（最大5個）
1. [質問1]
   - 仮定: [仮定内容]
   - 承認必要: [Yes/No]

2. [質問2]
   - 仮定: [仮定内容]
   - 承認必要: [Yes/No]

### 実装アプローチの選択（該当する場合）
**アプローチA: [名前]**
- メリット: [メリット]
- デメリット: [デメリット]

**アプローチB: [名前]**
- メリット: [メリット]
- デメリット: [デメリット]
```

### 3. 実装方針（Plan）

**目的**: 実装の全体像を計画し、変更範囲を明確にする

**実行内容**:

- 変更ファイル候補をリストアップする
- 差分の粒度を明確にする（一度に大きな変更をしない）
- テスト追加箇所を特定する
- 実装の順序を決定する（型定義 → Repository → Service → API → Composables → Components → Pages）

**出力形式**:

```markdown
## 実装方針

### 変更ファイル候補
- `shared/schemas/**`: [変更内容]
- `server/repositories/**`: [変更内容]
- `server/services/**`: [変更内容]
- `server/api/**`: [変更内容]
- `app/composables/**`: [変更内容]
- `app/components/**`: [変更内容]
- `app/pages/**`: [変更内容]

### 実装順序
1. [ステップ1]: [ファイル名]
2. [ステップ2]: [ファイル名]
...

### テスト追加箇所
- [テストケース1]: [ファイル名]
- [テストケース2]: [ファイル名]

### 差分の粒度
- 各ステップで動作確認可能な状態を保つ
- 一度に1つの機能を実装する
```

### 4. 実装（差分最小）

**目的**: 計画に従って段階的に実装を進める

**実行内容**:

- 実装方針で決定した順序に従って実装する
- 一度に1つの機能を実装し、各ステップで動作確認可能な状態を保つ
- 既存パターンとの一貫性を維持する
- 命名規則、ディレクトリ構造、型安全性を遵守する
- エラーハンドリングを忘れずに実装する

**実装の原則**:

- 小さなステップで進める
- 各ステップで進捗を報告する
- 問題が発生した場合は早期に報告する

**進捗報告形式**:

```markdown
## 実装進捗

### 完了したステップ
- [ステップ1]: ✅ 完了
- [ステップ2]: ✅ 完了

### 現在のステップ
- [ステップ3]: 🔄 進行中

### 次のステップ
- [ステップ4]: 次に実施予定
```

### 5. 自己レビュー（チェックリスト）【必須工程】

**目的**: 実装の品質を確保し、潜在的な問題を早期に発見する

**重要**: このステップをスキップすると、バイブコーディングの事故率が激増します。必ず実施してください。

**実行内容**:
以下のチェックリストを**必ずすべて確認**してください：

#### セキュリティチェック

- [ ] 入力値のサニタイズとバリデーション（Zodスキーマによる検証）
- [ ] SQLインジェクション対策（Prisma等のORM使用時は自動保護、生クエリには注意）
- [ ] XSS対策（ユーザー入力の適切なエスケープ）
- [ ] CSRF対策（状態変更リクエストでCSRFトークン検証）
- [ ] 認証・認可の適切な実装
- [ ] 機密情報の漏洩防止（環境変数使用、ログに出力しない）

#### 例外系チェック

- [ ] エラーハンドリングが適切に実装されているか
- [ ] `createError()` や `handleApiException()` を適切に使用しているか
- [ ] ユーザーフレンドリーなエラーメッセージを表示しているか
- [ ] ログに適切な情報を記録しているか（機密情報を含まない）

#### 境界値チェック

- [ ] null/undefined の処理
- [ ] 空配列の処理
- [ ] 境界値（最大値・最小値）の処理
- [ ] エッジケースの考慮

#### 命名チェック

- [ ] 命名規則に従っているか（CamelCase、kebab-case）
- [ ] 意味が明確か
- [ ] 既存コードとの一貫性があるか

#### 責務分離チェック

- [ ] APIハンドラは薄く保たれているか（ビジネスロジック禁止）
- [ ] Service層で入力検証とDTO変換が行われているか
- [ ] Repository層でDBアクセスのみが行われているか
- [ ] 3層責務分離が守られているか

#### 型安全性チェック

- [ ] TypeScriptの型が適切に使用されているか
- [ ] `any`型の使用を避けているか
- [ ] Zodスキーマでバリデーションを行っているか

#### パフォーマンスチェック

- [ ] 不要な再レンダリングを避けているか
- [ ] 重い処理が最適化されているか
- [ ] 画像やアセットが最適化されているか

#### アクセシビリティチェック

- [ ] WAI-ARIAガイドラインに従っているか
- [ ] キーボード操作をサポートしているか
- [ ] スクリーンリーダーに対応しているか

**出力形式**:

```markdown
## 自己レビュー結果

### ✅ 確認済み項目
- [セキュリティ]: ✅ すべて確認済み
- [例外系]: ✅ すべて確認済み
- [境界値]: ✅ すべて確認済み
- [命名]: ✅ すべて確認済み
- [責務分離]: ✅ すべて確認済み
- [型安全性]: ✅ すべて確認済み
- [パフォーマンス]: ✅ すべて確認済み
- [アクセシビリティ]: ✅ すべて確認済み

### ⚠️ 改善が必要な項目
- [項目1]: [問題点] → [修正案]
- [項目2]: [問題点] → [修正案]
```

### 6. リファクタ（必要時のみ）

**目的**: コードの品質を向上させ、保守性を高める

**実行内容**:

- 自己レビューで発見された問題を修正する
- コードの重複を特定し、共通化を検討する
- 可読性・保守性を向上させる改善を行う
- **重要**: 機能を変更しない（動作は維持）

**リファクタリングの原則**:

- 小さなステップで進める
- テスト可能な状態を保つ
- 既存の動作を壊さない

**出力形式**:

```markdown
## リファクタリング内容

### 実施した改善
- [改善1]: [説明]
- [改善2]: [説明]

### 変更ファイル
- [ファイル1]: [変更内容]
- [ファイル2]: [変更内容]
```

### 7. リント/フォーマット

**目的**: コードの品質と一貫性を確保する

**実行内容**:

- リンターを実行し、エラーを確認する
- フォーマッターを実行し、コードスタイルを統一する
- 型チェックを実行し、型エラーがないか確認する
- ビルドエラーがないか確認する

**実行コマンド**:

```bash
# リンター実行
pnpm lint

# リンター自動修正
pnpm lint:fix

# 型チェック
pnpm typecheck

# ビルド確認
pnpm build
```

**出力形式**:

```markdown
## リント/フォーマット結果

### 実行結果
- [ ] `pnpm lint`: ✅ エラーなし
- [ ] `pnpm lint:fix`: ✅ 自動修正完了
- [ ] `pnpm typecheck`: ✅ エラーなし
- [ ] `pnpm build`: ✅ ビルド成功

### 修正内容
- [修正1]: [説明]
- [修正2]: [説明]
```

### 8. ドキュメント更新

**目的**: 実装内容を記録し、後続の作業に役立てる

**実行内容**:

- タスクリストのチェックマークを更新する（該当する場合）
- 変更内容をテンプレートに記録する
- Notionに記載する（該当する場合）

**更新すべきドキュメント**:

- `docs/ui-implementation-tasks.md` などのタスクリスト
- `docs/api-design.md` などの設計ドキュメント（API変更時）
- `docs/database-design.md` などの設計ドキュメント（DB変更時）
- README.md（プロジェクト全体の変更時）

**出力形式**:

```markdown
## ドキュメント更新

### 実装日時
[日時]

### 実装内容
[実装内容の説明]

### 変更ファイル
- [ファイル1]: [変更内容]
- [ファイル2]: [変更内容]

### 関連タスク
- [タスク1]: ✅ 完了
- [タスク2]: ✅ 完了

### ドキュメント更新
- [ ] `docs/ui-implementation-tasks.md`: ✅ 更新済み
- [ ] `docs/api-design.md`: ✅ 更新済み（該当する場合）
- [ ] `docs/database-design.md`: ✅ 更新済み（該当する場合）
```

## 重要な注意事項

1. **順序の遵守**: 必ずこの順序で実行してください。順序を変えると事故率が増加します。
2. **自己レビューの必須化**: ステップ5の自己レビューをスキップすると、バイブコーディングの事故率が激増します。必ず実施してください。
3. **小さなステップ**: 一度に大きな変更をせず、小さなステップで進めてください。
4. **既存パターンの遵守**: 既存のコードパターンに従ってください。
5. **承認が必要な判断**: UI/UXの変更、破壊的変更、技術スタックの変更などは事前承認が必要です。

## ベストプラクティス

- 各ステップで進捗を報告する
- 問題が発生した場合は早期に報告する
- 不明点がある場合は、仮定を明記して進める
- 実装前に承認が必要な判断事項を明確にする
- コードレビューで発見された問題は必ず修正する
